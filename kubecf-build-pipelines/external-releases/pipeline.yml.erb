---
<%
# This pipeline is intended to build images for external releases using fissile.
#

external_releases = [
  {
    name: "cf-sle15-release",
    url: "https://s3.amazonaws.com/suse-final-releases/sle15-release",
    versions: 
    [
      "10.68",
      "10.69"
    ]
  },
  {
    name: "credhub-release",
    url: "https://bosh.io/d/github.com/pivotal-cf/credhub-release",
    versions:
    [
      "2.5.8",
      "2.5.9"
    ]
  }
]

# Convert a multiline string into a string with literal '\n's for YAML to parse as multiline string
class ::String
  def yamlify()
    self.gsub("\n", '\n')
  end
end
%>

resources:
- name: ci
  type: git
  source:
    uri: <%= ci_repo %>
    branch: <%= ci_branch %>
- name: build-image-resource
  type: git
  source:
    uri: <%= build_image_resource_repo %>
    branch: <%= build_image_resource_branch %>
- name: s3.fissile-linux
  type: s3
  source:
    bucket: <%= fissile_linux_s3_bucket %>
    private: true
    regexp: fissile/develop/fissile-(.*)\.tgz
- name: s3.fissile-stemcell-version
  type: s3
  source:
    bucket: <%= stemcell_versions_s3_bucket %>
    region_name: <%= stemcell_s3_bucket_region %>
    access_key_id: <%= s3_access_key %>
    secret_access_key: <%= s3_secret_key %>
    versioned_file: <%= stemcell_version_file %>

jobs:
<% external_releases.each do |release| %>
  - name: build-image-<%= release[:name] %>
    plan:
    - in_parallel:
      - get: ci
      - get: build-image-resource
      - get: s3.fissile-stemcell-version
        trigger: true
      - get: s3.fissile-linux
        trigger: true
    - do:
    <% release[:versions].each do |version| %>
      - task: build-<%= version %>
        privileged: true
        input_mapping:
          s3.stemcell-version: s3.fissile-stemcell-version 
        params:
          STEMCELL_REPOSITORY: <%= stemcell_repository %>
          STEMCELL_VERSIONED_FILE: <%= stemcell_version_file %>
          REGISTRY_NAME: <%= registry_name %>
          REGISTRY_ORG: <%= registry_org %>
          REGISTRY_USER: <%= registry_user %>
          REGISTRY_PASS: <%= registry_pass %>
          RELEASE_NAME: <%= release[:name] %>
          RELEASE_VERSION: <%= version %>
          RELEASE_URL: <%= release[:url] %>
        file: ci/kubecf-build-pipelines/buildpacks/tasks/build.yml
    <% end %>  
<% end %>
