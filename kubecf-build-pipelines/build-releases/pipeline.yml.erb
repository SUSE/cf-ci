---
<%

# When trigger_path is set, this will be monitored by concourse for changes,
# otherwise the whole repo will be monitored.
#
# When release_dir is set, a bosh release will be created from within that directory, otherwise
# the root directory will be used.
releases = [
  {
    name: "garden-runc",
    uri: "git@github.com:bikramnehra/garden-runc-release.git",
    branch: "v1.19.5-bump-automake"
    trigger_path: "config/blobs.yml",
    name_in_role_manifest: "garden-runc"
  }
]
%>

resources:
- name: ci
  type: git
  source:
    uri: <%= ci_repo %>
    branch: <%= ci_branch %>

<% releases.each do |release| %>
- name: git.<%= release[:name] %>-release
  type: git
  source:
    uri: <%= release[:uri] %>
    branch: <%= release[:branch] %>
    submodules: all
    private_key: |
      <%= github_private_key.gsub("\n", "\n      ") %>

- name: s3.suse-release-<%= release[:name] %>
  type: s3
  source:
    bucket: <%= releases_bucket %>
    region_name: <%= releases_bucket_region %>
    regexp: <%= release[:name] %>-release-(.*).tgz
    access_key_id: <%= s3_access_key %>
    secret_access_key: <%= s3_secret_key %>
    private_key: |
      <%= github_private_key.gsub("\n", "\n      ") %>

<% end %>

jobs:
<% releases.each do |release| %>
- name: create-<%= release[:name] %>-final-release
  plan:
  - in_parallel:
    - get: ci
      params:
        submodules: none
    - get: git.<%= release[:name] %>-release
      <% if release[:trigger_path] %>
      trigger: true
      <% end %>
  
  - task: build_release
    input_mapping: { release: git.<%= release[:name] %>-release }
    params:
      RELEASE_NAME: <%= release[:name] %>
      RELEASE_DIRECTORY: <%= release[:release_dir].to_s.inspect %>
      ACCESS_KEY_ID: <%= release[:s3_access_key] %>
      SECRET_ACCESS_KEY: <%= release[:s3_secret_key] %>
    file: ci/kubecf-build-pipelines/build-releases/tasks/build.yml
  
  - put: s3.suse-release-<%= release[:name] %>
    params:
      file: release_tarball_dir/<%= release[:name] %>-release-*.tgz
      acl: public-read

<% end %>
