---
<%

# When trigger_path is set, this will be monitored by concourse for changes,
# otherwise the whole repo will be monitored.
#
# When release_dir is set, a bosh release will be created from within that directory, otherwise
# the root directory will be used.
releases = [
  {
    name: "garden-runc",
    uri: "git@github.com:bikramnehra/garden-runc-release.git",
    trigger_path: "config/blobs.yml",
    name_in_role_manifest: "garden-runc"
  }
]
%>

resources:
- name: ci
  type: git
  source:
    uri: <%= ci_repo %>
    branch: <%= ci_branch %>

<% releases.each do |release| %>
- name: git.<%= release[:name] %>-release
  type: git
  source:
    uri: <%= release[:uri] %>
    branch: master
    submodules: all
    private_key: |
      <%= github_private_key.gsub("\n", "\n      ") %>

- name: s3.suse-final-release-<%= release[:name] %>
  type: s3
  source:
    bucket: <%= releases_bucket %>
    regexp: <%= release[:name] %>-release-(.*).tgz
    access_key_id: <%= aws_access_key %>
    secret_access_key: <%= aws_secret_key %>
    private_key: |
      <%= github_private_key.gsub("\n", "\n      ") %>

- name: <%= release[:name] %>-gh-release
  type: github-release
  source:
    owner: SUSE
    repository: <%= release[:uri].match(/.*\/(.*)\.git/)[1] %>
    access_token: ((github-access-token))
<% end %>

- name: git.scf
  type: git
  source:
    uri: git@github.com:SUSE/scf.git
    branch: develop

jobs:
<% releases.each do |release| %>
- name: create-<%= release[:name] %>-final-release
  plan:
  - in_parallel:
    - get: ci
      params:
        submodules: none
    - get: git.<%= release[:name] %>-release
      <% if release[:trigger_path] %>
      trigger: true
      <% end %>
  - task: build_final_release
    input_mapping: { release: git.<%= release[:name] %>-release }
    params:
      RELEASE_NAME: <%= release[:name] %>
      RELEASE_DIRECTORY: <%= release[:release_dir].to_s.inspect %>
      ACCESS_KEY_ID: <%= release[:aws_access_key] %>
      SECRET_ACCESS_KEY: <%= release[:aws_secret_key] %>
  - put: s3.suse-final-release-<%= release[:name] %>
    params:
      file: release_tarball_dir/<%= release[:name] %>-release-*.tgz
      acl: public-read
  - put: git.push-<%= release[:name] %>-release
    params: { repository: "git_output" }
  - put: <%= release[:name] %>-gh-release
    params:
      name: "release_tarball_dir/VERSION"
      tag: "release_tarball_dir/VERSION"
      commitish: "release_tarball_dir/target_commit"
      body: "release_tarball_dir/release_body"
<% end %>
